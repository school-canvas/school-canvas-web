<app-page-header
  title="Library"
  [showBackButton]="true"
  icon="local_library">
</app-page-header>

<div class="library-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <app-stats-card
        title="Total Borrowed"
        [value]="stats.totalBorrowed.toString()"
        icon="menu_book"
        color="primary">
      </app-stats-card>

      <app-stats-card
        title="Currently Borrowed"
        [value]="stats.currentlyBorrowed.toString()"
        icon="bookmark"
        color="success">
      </app-stats-card>

      <app-stats-card
        title="Overdue"
        [value]="stats.overdue.toString()"
        icon="warning"
        color="error">
      </app-stats-card>

      <app-stats-card
        title="Total Fines"
        [value]="'$' + stats.totalFines.toFixed(2)"
        icon="payments"
        color="warning">
      </app-stats-card>
    </div>

    <!-- Tabs for Browse and My Books -->
    <mat-tab-group [(selectedIndex)]="selectedTab" class="library-tabs">
      <!-- Browse Books Tab -->
      <mat-tab label="Browse Books">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">search</mat-icon>
          Browse Books
        </ng-template>

        <div class="tab-content">
          <!-- Search and Filters -->
          <div class="filters-section">
            <mat-form-field class="search-field" appearance="outline">
              <mat-label>Search books</mat-label>
              <input
                matInput
                [formControl]="searchControl"
                placeholder="Search by title, author, or ISBN">
              <mat-icon matPrefix>search</mat-icon>
              <button
                *ngIf="searchControl.value"
                matSuffix
                mat-icon-button
                (click)="clearSearch()"
                matTooltip="Clear search">
                <mat-icon>close</mat-icon>
              </button>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Category</mat-label>
              <mat-select [formControl]="categoryFilter">
                <mat-option value="all">All Categories</mat-option>
                <mat-option *ngFor="let category of categories.slice(1)" [value]="category">
                  {{ category }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Availability</mat-label>
              <mat-select [formControl]="availabilityFilter">
                <mat-option value="all">All Books</mat-option>
                <mat-option value="available">Available Only</mat-option>
                <mat-option value="unavailable">Unavailable</mat-option>
              </mat-select>
            </mat-form-field>

            <button
              mat-stroked-button
              (click)="clearFilters()"
              class="clear-filters-btn">
              <mat-icon>clear_all</mat-icon>
              Clear Filters
            </button>
          </div>

          <!-- Books Grid -->
          <div class="books-count">
            Showing {{ filteredBooks.length }} book<span *ngIf="filteredBooks.length !== 1">s</span>
          </div>

          <div *ngIf="filteredBooks.length === 0" class="empty-state-wrapper">
            <app-empty-state
              icon="library_books"
              message="No books found"
              description="Try adjusting your search or filters.">
            </app-empty-state>
          </div>

          <div *ngIf="filteredBooks.length > 0" class="books-grid">
            <mat-card *ngFor="let book of filteredBooks" class="book-card">
              <div class="book-cover">
                <mat-icon>menu_book</mat-icon>
                <div
                  *ngIf="book.availableCopies === 0"
                  class="unavailable-badge">
                  Unavailable
                </div>
              </div>

              <mat-card-content>
                <h3 class="book-title" [matTooltip]="book.title">{{ book.title }}</h3>
                <p class="book-author">by {{ book.author }}</p>
                
                <div class="book-details">
                  <mat-chip-set>
                    <mat-chip>{{ book.category }}</mat-chip>
                  </mat-chip-set>
                  
                  <div class="book-info">
                    <div class="info-item">
                      <mat-icon>label</mat-icon>
                      <span>{{ book.isbn }}</span>
                    </div>
                    <div class="info-item">
                      <mat-icon>location_on</mat-icon>
                      <span>{{ book.shelfLocation }}</span>
                    </div>
                    <div class="info-item">
                      <mat-icon>inventory_2</mat-icon>
                      <span>{{ book.availableCopies }}/{{ book.totalCopies }} available</span>
                    </div>
                  </div>

                  <p class="book-description">{{ book.description }}</p>
                </div>
              </mat-card-content>

              <mat-card-actions>
                <button
                  mat-raised-button
                  color="primary"
                  [disabled]="book.availableCopies === 0"
                  (click)="borrowBook(book)">
                  <mat-icon>add</mat-icon>
                  Borrow
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </mat-tab>

      <!-- My Books Tab -->
      <mat-tab label="My Books">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon" [matBadge]="stats.currentlyBorrowed" matBadgeColor="primary">bookmark</mat-icon>
          My Books
        </ng-template>

        <div class="tab-content">
          <div *ngIf="borrowedBooks.length === 0" class="empty-state-wrapper">
            <app-empty-state
              icon="bookmark_border"
              message="No borrowed books"
              description="Browse the library and borrow some books!">
            </app-empty-state>
          </div>

          <div *ngIf="borrowedBooks.length > 0" class="borrowed-books-list">
            <mat-card *ngFor="let borrowed of borrowedBooks" class="borrowed-book-card">
              <div class="borrowed-book-content">
                <div class="book-icon">
                  <mat-icon>menu_book</mat-icon>
                </div>

                <div class="book-info-section">
                  <h3 class="book-title">{{ borrowed.book.title }}</h3>
                  <p class="book-author">by {{ borrowed.book.author }}</p>
                  
                  <div class="borrow-details">
                    <div class="detail-item">
                      <mat-icon>event</mat-icon>
                      <span>Borrowed: {{ formatDate(borrowed.borrowDate) }}</span>
                    </div>
                    <div class="detail-item" [class.overdue]="isOverdue(borrowed.dueDate)">
                      <mat-icon>event_available</mat-icon>
                      <span>{{ getDueDateText(borrowed.dueDate) }}</span>
                    </div>
                    <div *ngIf="borrowed.returnDate" class="detail-item">
                      <mat-icon>check_circle</mat-icon>
                      <span>Returned: {{ formatDate(borrowed.returnDate) }}</span>
                    </div>
                    <div *ngIf="borrowed.renewalCount > 0" class="detail-item">
                      <mat-icon>autorenew</mat-icon>
                      <span>Renewed {{ borrowed.renewalCount }} time<span *ngIf="borrowed.renewalCount > 1">s</span></span>
                    </div>
                    <div *ngIf="borrowed.fineAmount && borrowed.fineAmount > 0" class="detail-item fine">
                      <mat-icon>warning</mat-icon>
                      <span>Fine: ${{ borrowed.fineAmount.toFixed(2) }}</span>
                    </div>
                  </div>
                </div>

                <div class="status-section">
                  <mat-chip
                    [class.status-borrowed]="borrowed.status === 'BORROWED'"
                    [class.status-returned]="borrowed.status === 'RETURNED'"
                    [class.status-overdue]="borrowed.status === 'OVERDUE'"
                    [class.status-renewed]="borrowed.status === 'RENEWED'">
                    {{ borrowed.status }}
                  </mat-chip>
                </div>
              </div>

              <mat-card-actions *ngIf="borrowed.status !== 'RETURNED'" class="borrowed-actions">
                <button
                  mat-stroked-button
                  color="primary"
                  [disabled]="borrowed.renewalCount >= 2"
                  (click)="renewBook(borrowed)"
                  matTooltip="{{ borrowed.renewalCount >= 2 ? 'Maximum renewals reached' : 'Renew for 14 more days' }}">
                  <mat-icon>autorenew</mat-icon>
                  Renew
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="returnBook(borrowed)">
                  <mat-icon>assignment_return</mat-icon>
                  Return
                </button>
              </mat-card-actions>
            </mat-card>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
