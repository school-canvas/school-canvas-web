<app-page-header
  title="My Attendance"
  [showBackButton]="true"
  icon="calendar_today">
</app-page-header>

<div class="attendance-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <app-stats-card
        title="Attendance Rate"
        [value]="stats.attendanceRate.toFixed(1) + '%'"
        icon="trending_up"
        color="primary">
      </app-stats-card>

      <app-stats-card
        title="Present Days"
        [value]="stats.presentDays + ' / ' + stats.totalDays"
        icon="check_circle"
        color="success">
      </app-stats-card>

      <app-stats-card
        title="Absent Days"
        [value]="stats.absentDays.toString()"
        icon="cancel"
        color="error">
      </app-stats-card>

      <app-stats-card
        title="Late Arrivals"
        [value]="stats.lateDays.toString()"
        icon="schedule"
        color="warning">
      </app-stats-card>
    </div>

    <!-- Calendar Controls -->
    <div class="calendar-controls">
      <div class="view-mode-toggle">
        <mat-button-toggle-group
          [value]="viewMode"
          (change)="onViewModeChange($event.value)">
          <mat-button-toggle value="month">
            <mat-icon>calendar_view_month</mat-icon>
            Month
          </mat-button-toggle>
          <mat-button-toggle value="week">
            <mat-icon>view_week</mat-icon>
            Week
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <div class="navigation-controls">
        <button
          mat-icon-button
          (click)="viewMode === 'month' ? previousMonth() : previousWeek()"
          matTooltip="Previous {{ viewMode }}">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <button
          mat-button
          (click)="goToToday()"
          class="today-button">
          Today
        </button>

        <button
          mat-icon-button
          (click)="viewMode === 'month' ? nextMonth() : nextWeek()"
          matTooltip="Next {{ viewMode }}">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <div class="period-display">
        <h2>{{ getCurrentMonthYear() }}</h2>
      </div>

      <div class="action-buttons">
        <button
          mat-stroked-button
          (click)="printAttendance()">
          <mat-icon>print</mat-icon>
          Print
        </button>
        <button
          mat-stroked-button
          color="primary"
          (click)="downloadAttendance()">
          <mat-icon>download</mat-icon>
          Download
        </button>
      </div>
    </div>

    <!-- Calendar View -->
    <mat-card class="calendar-card">
      <mat-card-content>
        <!-- Calendar Header -->
        <div class="calendar-header">
          <div
            *ngFor="let day of weekDays"
            class="calendar-header-day">
            {{ day }}
          </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid">
          <div
            *ngFor="let day of calendarDays"
            class="calendar-day"
            [class.other-month]="!day.isCurrentMonth"
            [class.today]="day.isToday"
            [class.weekend]="day.isWeekend"
            [class.has-attendance]="day.attendance">
            
            <div class="day-number">{{ day.dayNumber }}</div>

            <div *ngIf="day.attendance" class="attendance-indicator">
              <mat-icon
                [class]="getStatusClass(day.attendance.status)"
                [matTooltip]="day.attendance.status + (day.attendance.remarks ? ': ' + day.attendance.remarks : '')"
                matTooltipPosition="above">
                {{ getStatusIcon(day.attendance.status) }}
              </mat-icon>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Attendance Legend -->
    <div class="legend-section">
      <h3>Legend</h3>
      <div class="legend-items">
        <div class="legend-item">
          <mat-icon class="status-present">check_circle</mat-icon>
          <span>Present</span>
        </div>
        <div class="legend-item">
          <mat-icon class="status-absent">cancel</mat-icon>
          <span>Absent</span>
        </div>
        <div class="legend-item">
          <mat-icon class="status-late">schedule</mat-icon>
          <span>Late</span>
        </div>
        <div class="legend-item">
          <mat-icon class="status-excused">assignment_turned_in</mat-icon>
          <span>Excused</span>
        </div>
      </div>
    </div>

    <!-- Recent Attendance History -->
    <div class="history-section">
      <h3 class="section-title">Attendance History</h3>

      <div *ngIf="recentAttendance.length === 0" class="empty-state-wrapper">
        <app-empty-state
          icon="event_available"
          message="No attendance records found"
          description="Your attendance will appear here once recorded.">
        </app-empty-state>
      </div>

      <mat-card *ngIf="recentAttendance.length > 0" class="history-card">
        <mat-card-content>
          <table mat-table [dataSource]="recentAttendance" class="attendance-table">
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let record">
                {{ formatDate(record.date) }}
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let record">
                <mat-chip
                  [class]="getStatusClass(record.status)"
                  [disabled]="true">
                  <mat-icon>{{ getStatusIcon(record.status) }}</mat-icon>
                  {{ record.status }}
                </mat-chip>
              </td>
            </ng-container>

            <!-- Class Column -->
            <ng-container matColumnDef="class">
              <th mat-header-cell *matHeaderCellDef>Class</th>
              <td mat-cell *matCellDef="let record">
                {{ record.className || 'N/A' }}
              </td>
            </ng-container>

            <!-- Remarks Column -->
            <ng-container matColumnDef="remarks">
              <th mat-header-cell *matHeaderCellDef>Remarks</th>
              <td mat-cell *matCellDef="let record">
                {{ record.remarks || '-' }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
